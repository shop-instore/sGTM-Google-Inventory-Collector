___INFO___

{
  "type": "TAG",
  "id": "cvt_temp_public_id",
  "version": 1,
  "securityGroups": [],
  "displayName": "Google Inventory Collector",
  "brand": {
    "id": "brand_dummy",
    "displayName": "",
    "thumbnail": "data:image/png;base64,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\u003d"
  },
  "description": "Collects product inventory data.",
  "containerContexts": [
    "SERVER"
  ]
}


___TEMPLATE_PARAMETERS___

[
  {
    "type": "TEXT",
    "name": "merchant_id",
    "displayName": "Google Merchant Center ID",
    "simpleValueType": true,
    "valueValidators": [
      {
        "type": "POSITIVE_NUMBER"
      },
      {
        "type": "NON_EMPTY"
      }
    ],
    "help": "The Merchant Center ID."
  },
  {
    "type": "TEXT",
    "name": "api_key",
    "displayName": "API Key",
    "simpleValueType": true,
    "valueValidators": [
      {
        "type": "NON_EMPTY"
      }
    ],
    "help": "The API Key provided by Google LIA team."
  },
  {
    "type": "GROUP",
    "name": "feed_target",
    "displayName": "Set targeted feed country and language",
    "groupStyle": "ZIPPY_OPEN_ON_PARAM",
    "subParams": [
      {
        "type": "TEXT",
        "name": "target_country",
        "displayName": "Target Country",
        "simpleValueType": true,
        "valueValidators": [
          {
            "type": "STRING_LENGTH",
            "args": [
              2,
              2
            ]
          }
        ],
        "help": "The target country parameter that matches your primary feed configuration. \u003cbr/\u003e Use ISO 3166-1 alpha-2 format. (For example, \u0027US\u0027 for United States)"
      },
      {
        "type": "TEXT",
        "name": "language",
        "displayName": "Language",
        "simpleValueType": true,
        "valueValidators": [
          {
            "type": "STRING_LENGTH",
            "args": [
              2,
              2
            ]
          }
        ],
        "help": "The language parameter that matches your primary feed configuration. \u003cbr/\u003e Use ISO 639-1 alpha-2 code format. (For example, \u0027en\u0027 for English)"
      }
    ],
    "help": "Default value read from event data if input field is not set."
  },
  {
    "type": "GROUP",
    "name": "inventory",
    "displayName": "Set Inventory Parameters",
    "groupStyle": "ZIPPY_OPEN",
    "subParams": [
      {
        "type": "TEXT",
        "name": "item_id",
        "displayName": "Item ID",
        "simpleValueType": true,
        "valueValidators": [
          {
            "type": "STRING_LENGTH",
            "args": [
              1,
              50
            ]
          }
        ],
        "help": "The ID attribute that uniquely identifies each product. \u003ca href\u003d\\\"https://support.google.com/merchants/answer/6324405\\\" target\u003d\\\"_blank\\\"\u003eLearn more\u003c/a\u003e"
      },
      {
        "type": "TEXT",
        "name": "store_code",
        "displayName": "Store Code",
        "simpleValueType": true,
        "enablingConditions": [],
        "valueValidators": [
          {
            "type": "STRING_LENGTH",
            "args": [
              1,
              60
            ]
          }
        ],
        "help": "The store code attribute used to specify the unique alphanumeric identifier of a local shop. \u003ca href\u003d\\\"https://support.google.com/merchants/answer/13869896\\\" target\u003d\\\"_blank\\\"\u003eLearn more\u003c/a\u003e"
      },
      {
        "type": "TEXT",
        "name": "price",
        "displayName": "Price",
        "simpleValueType": true,
        "valueValidators": [
          {
            "type": "REGEX",
            "args": [
              "^(([0-9]+\\.)?)+[0-9]+ +[a-zA-Z]+$"
            ],
            "errorMessage": "The price string should match format of \"number plus currency (use ISO 4217)\", e.g. \"1.98 USD\"."
          }
        ],
        "help": "The price attribute to tell users how much you’re charging for your product. \u003cbr/\u003eFormat: Number plus currency. \u003ca href\u003d\\\"https://support.google.com/merchants/answer/6324371\\\" target\u003d\\\"_blank\\\"\u003eLearn more\u003c/a\u003e"
      },
      {
        "type": "TEXT",
        "name": "availability",
        "displayName": "Availability (In Store)",
        "simpleValueType": true,
        "enablingConditions": [],
        "valueValidators": [],
        "help": "The availability attribute to tell users and Google whether you have a product in stock at your local store. \u003cbr/\u003eSupported values: in_stock, limited, out_of_stock."
      },
      {
        "type": "GROUP",
        "name": "bopis",
        "displayName": "(Optional) Pickup Attributes",
        "groupStyle": "NO_ZIPPY",
        "subParams": [
          {
            "type": "TEXT",
            "name": "pickup_method",
            "displayName": "Pickup Method",
            "simpleValueType": true
          },
          {
            "type": "TEXT",
            "name": "pickup_sla",
            "displayName": "Pickup SLA",
            "simpleValueType": true
          }
        ],
        "help": "See \u003ca href\u003d\\\"https://support.google.com/merchants/answer/7029574\\\" target\u003d\\\"_blank\\\"\u003ePickup Today\u003c/a\u003e and \n\u003ca href\u003d\\\"https://support.google.com/merchants/answer/9439765\\\" target\u003d\\\"_blank\\\"\u003ePickup Later\u003c/a\u003e for different pickup attributes setup options."
      }
    ],
    "help": "Default value read from event data if input field is not set."
  }
]


___SANDBOXED_JS_FOR_SERVER___

const encodeUriComponent = require('encodeUriComponent');
const getEventData = require('getEventData');
const log = require('logToConsole');
const makeString = require('makeString');
const makeInteger = require('makeInteger');
const sendHttpGet = require('sendHttpGet');
const setCookie = require('setCookie');
const JSON = require('JSON');
const toBase64 = require('toBase64');

// Check required field merchant id from user input.
if (data.merchant_id == undefined || data.merchant_id <= 0) {
  log('Invalid Merchant ID!');
  data.gtmOnFailure(1);
  return;
}
const merchantId = makeInteger(data.merchant_id);

// Check required field API key from user input.
if (data.api_key == undefined || data.api_key.trim().length === 0) {
  log('Invalid API Key!');
  data.gtmOnFailure(2);
  return;
}
const apiKey = data.api_key.trim();

// page_location is automatically collected by the Google Analytics 4 tag.
// Therefore, it's safe to take it directly from event data rather than require
// the user to specify it. Use the getEventData API to retrieve a single data
// point from the event. There's also a getAllEventData API that returns the
// entire event.
const pageLocation = getEventData('page_location');

let inventory = {'merchant_id': merchantId};

if (!fetchInventoryAttributes()) {
  data.gtmOnFailure(3);
  return;
}

log('inventory pixel generated: ', inventory);

const url = 'https://wsri.googleapis.com/v1/' + 
      encodeUriComponent(toBase64(JSON.stringify(inventory))) +
      '?key=' + encodeUriComponent(apiKey);

// The sendHttpGet API takes a URL and returns a promise that resolves with the
// result once the request completes. You must call data.gtmOnSuccess() or
// data.gtmOnFailure() so that the container knows when the tag has finished
// executing.
sendHttpGet(url).then((result) => {
  if (result.statusCode >= 200 && result.statusCode < 300) {
    data.gtmOnSuccess();
  } else {
    data.gtmOnFailure();
  }
});

// Call data.gtmOnSuccess when the tag is finished.
data.gtmOnSuccess();

// Fill in inventory attributes based on parameters passed from event data.
function fetchInventoryAttributes() {
  const required_attributes = ['item_id', 'store_code', 'availability', 'price', 'language', 'target_country'];
  for (const attr of required_attributes) {
    const value = data[attr] || getEventData(attr);
    if (value != undefined && value != null && value.trim().length > 0) {
      inventory[attr] = value.trim();
    } else {
      log('Missing value for input field ', attr);
      return false;
    }
  }

  const optional_attributes = ['pickup_method', 'pickup_sla'];
  for (const attr of optional_attributes) {
    const value = data[attr] || getEventData(attr);
    if (value != undefined && value != null && value.trim().length > 0) {
      inventory[attr] = value.trim();
    }
  }
  return true;
}


___SERVER_PERMISSIONS___

[
  {
    "instance": {
      "key": {
        "publicId": "logging",
        "versionId": "1"
      },
      "param": [
        {
          "key": "environments",
          "value": {
            "type": 1,
            "string": "debug"
          }
        }
      ]
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "set_cookies",
        "versionId": "1"
      },
      "param": []
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "read_event_data",
        "versionId": "1"
      },
      "param": [
        {
          "key": "keyPatterns",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 1,
                "string": "event_name"
              },
              {
                "type": 1,
                "string": "page_location"
              },
              {
                "type": 1,
                "string": "item_id"
              },
              {
                "type": 1,
                "string": "store_code"
              },
              {
                "type": 1,
                "string": "price"
              },
              {
                "type": 1,
                "string": "currency"
              },
              {
                "type": 1,
                "string": "availability"
              },
              {
                "type": 1,
                "string": "language"
              },
              {
                "type": 1,
                "string": "target_country"
              },
              {
                "type": 1,
                "string": "pickup_method"
              },
              {
                "type": 1,
                "string": "pickup_sla"
              }
            ]
          }
        },
        {
          "key": "eventDataAccess",
          "value": {
            "type": 1,
            "string": "specific"
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "send_http",
        "versionId": "1"
      },
      "param": [
        {
          "key": "allowedUrls",
          "value": {
            "type": 1,
            "string": "specific"
          }
        },
        {
          "key": "urls",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 1,
                "string": "https://wsri.googleapis.com/"
              }
            ]
          }
        },
        {
          "key": "allowGoogleDomains",
          "value": {
            "type": 8,
            "boolean": true
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  }
]


___TESTS___

scenarios: []


___NOTES___

Created on 5/28/2024, 5:51:35 PM


